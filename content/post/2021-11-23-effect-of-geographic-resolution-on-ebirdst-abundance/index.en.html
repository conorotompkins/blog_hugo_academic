---
# Documentation: https://sourcethemes.com/academic/docs/managing-content/

title: "Effect of Geographic Resolution on ebirdst Abundance"
subtitle: ""
summary: ""
authors: [Conor Tompkins]
tags: [R, eBird]
categories: [R, eBird]
date: 2021-11-23T08:20:43-05:00
lastmod: 2021-11-23T08:20:43-05:00
featured: false
draft: false

# Featured image
# To use, add an image named `featured.jpg/png` to your page's folder.
# Focal points: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight.
image:
  caption: ""
  focal_point: ""
  preview_only: false

# Projects (optional).
#   Associate this post with one or more of your projects.
#   Simply enter your project's folder or file name without extension.
#   E.g. `projects = ["internal-project"]` references `content/project/deep-learning/index.md`.
#   Otherwise, set `projects = []`.
projects: []
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>


<p>While exploring some of the citizen science bird observation data available through <a href="https://cornelllabofornithology.github.io/ebirdst/"><code>ebirdst</code></a>, I was confused by how to understand the calculation of <code>ebirdst</code>’s <code>abundance</code> metric.</p>
<p>The <code>ebirdst</code> documentation (<code>?ebirdst::load_raster</code>) defines <code>abundance</code> as:</p>
<blockquote>
<p>the expected relative abundance, computed as the product of the probability of occurrence and the count conditional on occurrence, of the species on an eBird Traveling Count by a skilled eBirder starting at the optimal time of day with the optimal search duration and distance that maximizes detection of that species in a region.</p>
</blockquote>
<p>I had seen some weird results when trying to manually calculate <code>abundance</code> as <code>occurrence * count</code>. My initial attempt had aggregated the results by month.</p>
<p>The underlying problem is that <code>abundance</code> and <code>count</code> are the results of models, and are subject to model error. I also believe that the data outputted from <code>load_raster</code> lacks the necessary significant digits to accurately recreate <code>abundance</code>. Lowering the resolution or aggregating the data will exacerbate this issue.</p>
<p>This code loads my <a href="https://github.com/conorotompkins/ebird_shiny_app/blob/main/scripts/functions/pull_species_metric.R">convenience function</a> to retrieve a metric for a species at a given geographic resolution. This gets <code>occurrence</code>, <code>count</code>, and <code>abundance</code> for the Northern Cardinal at high (3 km), medium (9 km), and low resolutions (27 km). The function also crops the underlying raster data to Allegheny County, PA.</p>
<pre class="r"><code>library(here)
library(hrbrthemes)
library(patchwork)

source(&quot;https://raw.githubusercontent.com/conorotompkins/ebird_shiny_app/main/scripts/functions/pull_species_metric.R&quot;)

theme_set(theme_ipsum())

species_table &lt;- crossing(species = c(&quot;Northern Cardinal&quot;),
                          metric = c(&quot;occurrence&quot;, &quot;count&quot;, &quot;abundance&quot;),
                          resolution = c(&quot;hr&quot;, &quot;mr&quot;, &quot;lr&quot;))

species_table</code></pre>
<pre><code>## # A tibble: 9 × 3
##   species           metric     resolution
##   &lt;chr&gt;             &lt;chr&gt;      &lt;chr&gt;     
## 1 Northern Cardinal abundance  hr        
## 2 Northern Cardinal abundance  lr        
## 3 Northern Cardinal abundance  mr        
## 4 Northern Cardinal count      hr        
## 5 Northern Cardinal count      lr        
## 6 Northern Cardinal count      mr        
## 7 Northern Cardinal occurrence hr        
## 8 Northern Cardinal occurrence lr        
## 9 Northern Cardinal occurrence mr</code></pre>
<pre class="r"><code>species_metrics &lt;- species_table %&gt;% 
  mutate(data = pmap(list(species, metric, resolution), ~get_species_metric(..1, ..2, ..3))) %&gt;% 
  mutate(resolution = fct_relevel(resolution, c(&quot;hr&quot;, &quot;mr&quot;, &quot;lr&quot;))) %&gt;% 
  arrange(species, metric, resolution)</code></pre>
<pre><code>## 0.529 sec elapsed
## 17.896 sec elapsed
## 3.614 sec elapsed
## 0.175 sec elapsed
## 11.562 sec elapsed
## 0.083 sec elapsed
## 0.32 sec elapsed
## 13.026 sec elapsed
## 0.352 sec elapsed
## 0.287 sec elapsed
## 17.968 sec elapsed
## 3.382 sec elapsed
## 0.151 sec elapsed
## 11.612 sec elapsed
## 0.051 sec elapsed
## 0.273 sec elapsed
## 13.03 sec elapsed
## 0.351 sec elapsed
## 0.163 sec elapsed
## 18.18 sec elapsed
## 3.186 sec elapsed
## 0.167 sec elapsed
## 11.904 sec elapsed
## 0.051 sec elapsed
## 0.276 sec elapsed
## 13.492 sec elapsed
## 0.354 sec elapsed</code></pre>
<pre class="r"><code>species_metrics</code></pre>
<pre><code>## # A tibble: 9 × 4
##   species           metric     resolution data                    
##   &lt;chr&gt;             &lt;chr&gt;      &lt;fct&gt;      &lt;list&gt;                  
## 1 Northern Cardinal abundance  hr         &lt;tibble [1,813,448 × 7]&gt;
## 2 Northern Cardinal abundance  mr         &lt;tibble [221,312 × 7]&gt;  
## 3 Northern Cardinal abundance  lr         &lt;tibble [25,012 × 7]&gt;   
## 4 Northern Cardinal count      hr         &lt;tibble [1,813,448 × 7]&gt;
## 5 Northern Cardinal count      mr         &lt;tibble [221,312 × 7]&gt;  
## 6 Northern Cardinal count      lr         &lt;tibble [25,012 × 7]&gt;   
## 7 Northern Cardinal occurrence hr         &lt;tibble [1,813,448 × 7]&gt;
## 8 Northern Cardinal occurrence mr         &lt;tibble [221,312 × 7]&gt;  
## 9 Northern Cardinal occurrence lr         &lt;tibble [25,012 × 7]&gt;</code></pre>
<p>This unnests the data and recalculates abundance (<code>abundance_test</code>) and the difference between actual <code>abundance</code> and <code>abundance_test</code>.</p>
<pre class="r"><code>species_table_unnested &lt;- species_metrics %&gt;%
  unnest(data) %&gt;% 
  select(species, resolution, date, month, x, y, metric_desc, value) %&gt;% 
  pivot_wider(id_cols = c(species, resolution, date, month, x, y),
              names_from = metric_desc,
              values_from = value) %&gt;% 
  select(species, resolution, date, month, x, y, count, occurrence, abundance) %&gt;% 
  mutate(abundance_test = count * occurrence,
         diff = abundance - abundance_test)</code></pre>
<p>Grouping by month to get to the county level changes the grain of the data so much that <code>abundance_test</code> undershoots <code>abundance</code> by 20%. This occurs at all resolutions.</p>
<pre class="r"><code>species_metrics %&gt;%
  unnest(data) %&gt;% 
  select(species, resolution, date, month, x, y, metric_desc, value) %&gt;% 
  pivot_wider(id_cols = c(species, resolution, date, month, x, y),
              names_from = metric_desc,
              values_from = value) %&gt;% 
  select(species, resolution, date, month, x, y, count, occurrence, abundance) %&gt;% 
  group_by(species, month, resolution) %&gt;% 
  summarize(occurrence = mean(occurrence, na.rm = T),
            count = mean(count, na.rm = T),
            abundance = mean(abundance, na.rm = T)) %&gt;% 
  ungroup() %&gt;% 
  mutate(abundance_test = count * occurrence,
         diff = abundance - abundance_test) %&gt;% 
  ggplot(aes(abundance, abundance_test)) +
  geom_abline() +
  geom_point() +
  facet_wrap(~resolution) +
  tune::coord_obs_pred()</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Totally un-aggregated, <code>abundance_test</code> closely resembles <code>abundance</code>, but degrades as resolution decreases.</p>
<pre class="r"><code>species_table_unnested %&gt;% 
  select(abundance, abundance_test, resolution) %&gt;% 
  drop_na() %&gt;% 
  ggplot(aes(abundance, abundance_test)) +
  geom_density_2d_filled(contour_var = &quot;ndensity&quot;) +
  facet_wrap(~resolution) +
  tune::coord_obs_pred() +
  coord_cartesian(xlim = c(0, 8),
                  ylim = c(0, 8)) +
  guides(fill = guide_colorsteps())</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>At lower resolutions, the difference is positively skewed, which means that <code>abundance</code> is higher than <code>abundance_test.</code></p>
<pre class="r"><code>species_table_unnested %&gt;% 
  drop_na(diff) %&gt;% 
  ggplot(aes(diff)) +
  geom_histogram() +
  facet_wrap(~resolution, scale = &quot;free_y&quot;, ncol = 1)</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>At the highest resolution, <code>diff</code> is heteroskedastic. At lower resolutions, there are patterns to the error. When <code>occurrence</code> is between 50% and 90%, <code>diff</code> is again skewed positively.</p>
<pre class="r"><code>species_table_unnested %&gt;% 
  drop_na(occurrence, diff) %&gt;% 
  ggplot(aes(occurrence, diff)) +
  geom_density_2d_filled(contour_var = &quot;ndensity&quot;) +
  facet_wrap(~resolution) + 
  coord_cartesian(ylim = c(-.2, .2)) +
  scale_x_percent() +
  guides(fill = guide_colorsteps())</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>This was a useful exercise for me to understand how the geographic resolution and other aggregation of the data can affect estimated metrics, specifically in the citizen science context.</p>
