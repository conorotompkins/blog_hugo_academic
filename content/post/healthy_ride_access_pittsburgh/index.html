---
# Documentation: https://sourcethemes.com/academic/docs/managing-content/

title: "Bike rental access in Pittsburgh"
subtitle: ""
summary: ""
authors: [Conor Tompkins]
tags: [R, Pittsburgh, Healthy Ride, WPRDC]
categories: [R, Pittsburgh, Healthy Ride, WPRDC]
date: 2020-12-04
lastmod: 2020-12-04
featured: false
draft: false

# Featured image
# To use, add an image named `featured.jpg/png` to your page's folder.
# Focal points: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight.
image:
  caption: ""
  focal_point: ""
  preview_only: false

# Projects (optional).
#   Associate this post with one or more of your projects.
#   Simply enter your project's folder or file name without extension.
#   E.g. `projects = ["internal-project"]` references `content/project/deep-learning/index.md`.
#   Otherwise, set `projects = []`.
projects: []
---

<script src="index_files/header-attrs/header-attrs.js"></script>
<link href="index_files/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="index_files/anchor-sections/anchor-sections.js"></script>
<script src="index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="index_files/pymjs/pym.v1.js"></script>
<script src="index_files/widgetframe-binding/widgetframe.js"></script>
<script src="index_files/mapdeck-binding/mapdeck.js"></script>
<script src="index_files/mpadeck_functions/mapdeck_functions.js"></script>
<script src="index_files/deckgl/deckgl.min.js"></script>
<script src="index_files/legend/legend.js"></script>
<script src="index_files/title/title.js"></script>
<script src="index_files/mapdeck_location/mapdeck_location.js"></script>
<script src="index_files/mapdeck_colours/mapdeck_colours.js"></script>
<script src="index_files/mapdeck_coordinates/mapdeck_coordinates.js"></script>
<link href="index_files/mapboxgl/mapbox-gl.css" rel="stylesheet" />
<script src="index_files/mapboxgl/mapbox-gl.js"></script>
<link href="index_files/mapdeck/mapdeck.css" rel="stylesheet" />
<script src="index_files/mpadeck-binding/mapdeck.js"></script>
<script src="index_files/polygon/polygon.js"></script>
<script src="index_files/scatterplot/scatterplot.js"></script>


<p>This is an interactive Leaflet map of Healthy Ride access in Pittsburgh. It counts how many Healthy Ride stations are within a 10 minute bike ride of a given location. This gives an estimation of how accessible the Healthy Ride service is in a given neighborhood (lighter green = more accessible). As you zoom in, individual bike stations will appear. Click the “full screen” button on the left to maximize your view.</p>
<div id="htmlwidget-1" style="width:100%;height:480px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"index_files/figure-html//widgets/widget_unnamed-chunk-1.html","options":{"xdomain":"*","allowfullscreen":true,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>There are some obvious cases (like the Wabash Tunnel) where the API doesn’t know that a bicyclist shouldn’t go in there, but overall it is accurate.</p>
<p>This map was built with the Mapbox API and was inspired by the <a href="http://walker-data.com/MUSAmasterclass/tutorial/#4_Analyzing_elections_and_accessibility_with_mapboxapi">Penn MUSA Masterclass 2020 talk</a> that Kyle Walker gave.</p>
<div id="code" class="section level1">
<h1>Code</h1>
<p>This loads the required libraries:</p>
<pre class="r"><code>library(tidyverse)
library(janitor)
library(sf)
library(tigris)
library(raster)
library(fasterize)
library(mapboxapi)
library(mapdeck)
library(mapview)
library(leaflet)
library(leaflet.extras)
library(widgetframe)

options(tigris_use_cache = TRUE,
        scipen = 999,
        digits = 4)</code></pre>
<p>This finds the coordinates for the “middle” of the city and makes a base map that I will use later:</p>
<pre class="r"><code>pgh_coords &lt;- mb_geocode(&quot;Upper Hill, Pittsburgh, PA&quot;)

mapbox_map &lt;- leaflet() %&gt;%
  addMapboxTiles(style_id = &quot;streets-v11&quot;,
                 username = &quot;mapbox&quot;) </code></pre>
<p>This reads in the dataframe with the <a href="https://data.wprdc.org/dataset/healthyride-stations">station locations</a> and the shapefile of the <a href="https://data.wprdc.org/dataset/pittsburgh-city-boundary">city boundaries</a>.</p>
<pre class="r"><code>stations &lt;- read_csv(&quot;data/stations/healthy-ride-station-locations-2020-q2.csv&quot;,
                     col_types = cols(
                       `Station #` = col_character(),
                       `Station Name` = col_character(),
                       `# of Racks` = col_double(),
                       Latitude = col_double(),
                       Longitude = col_double()
                     )) %&gt;% 
  clean_names() %&gt;% 
  mutate(latitude = case_when(station_number == &quot;49391&quot; ~ latitude * -1,
                              TRUE ~ latitude))

city_boundary &lt;- st_read(&quot;data/Pittsburgh_City_Boundary-shp/City_Boundary.shp&quot;,
                         quiet = TRUE) %&gt;% 
  filter(FID != 7) %&gt;% 
  summarize() %&gt;% 
  st_boundary() %&gt;% 
  rmapshaper::ms_simplify(keep = .02)

station_map &lt;- mapbox_map %&gt;% 
  mapdeck() %&gt;% 
  add_polygon(data = city_boundary,
              fill_opacity = 0,
              stroke_width = 100,
              stroke_colour = &quot;#000000&quot;) %&gt;% 
  add_scatterplot(data = stations,
                  radius = 100) %&gt;% 
  mapdeck_view(location = c(pgh_coords[1], pgh_coords[2]), zoom = 11)

station_map</code></pre>
<div id="htmlwidget-2" style="width:672px;height:480px;" class="mapdeck html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"access_token":"pk.eyJ1IjoiY29ub3JvdG9tcGtpbnMiLCJhIjoiY2p2b2MxeTNqMTg3ZjRhbnQwMTk0ZGt0ZyJ9.tfEDs2o7n8kKtHvcTneG_g","style":"mapbox://styles/mapbox/streets-v9","pitch":0,"zoom":0,"location":[0,0],"bearing":0,"max_zoom":20,"min_zoom":0,"max_pitch":60,"min_pitch":0,"show_view_state":false,"repeat_view":false,"calls":[{"functions":"add_polygon_geo","args":["mapdeck",[{"type":"Feature","properties":{"elevation":0,"fill_colour":"#44015400","stroke_colour":"#000000","stroke_width":100.0},"geometry":{"geometry":{"type":"Polygon","coordinates":[[[-79.935195,40.396475],[-79.929575,40.389785],[-79.918154,40.399359],[-79.916005,40.38221],[-79.903345,40.371968],[-79.907067,40.36161],[-79.920552,40.365461],[-79.924899,40.375103],[-79.939435,40.373945],[-79.936127,40.388809],[-79.949536,40.390728],[-79.970075,40.404781],[-79.958984,40.409638],[-79.943821,40.394227],[-79.935195,40.396475]],[[-80.004107,40.374045],[-80.027813,40.39157],[-80.036413,40.404274],[-80.051211,40.401941],[-80.034883,40.428342],[-80.063834,40.426398],[-80.066125,40.417493],[-80.078736,40.416538],[-80.06865,40.431343],[-80.059806,40.428187],[-80.05829,40.444424],[-80.076598,40.447966],[-80.08292,40.440376],[-80.094697,40.451477],[-80.094631,40.459718],[-80.050688,40.462596],[-80.029958,40.446134],[-79.998828,40.431885],[-79.975011,40.432591],[-79.958271,40.424588],[-79.954573,40.410622],[-79.962772,40.409697],[-79.975256,40.40454],[-79.979846,40.39977],[-79.973027,40.388735],[-79.977959,40.381918],[-80.004107,40.374045]],[[-79.884042,40.482457],[-79.89,40.461877],[-79.865773,40.45578],[-79.867125,40.449459],[-79.885892,40.446961],[-79.892376,40.450351],[-79.899308,40.417054],[-79.912637,40.416009],[-79.932424,40.399349],[-79.94123,40.398387],[-79.950155,40.405439],[-79.953463,40.423281],[-79.963236,40.431457],[-79.977813,40.435366],[-79.997311,40.434252],[-80.012928,40.442213],[-79.995634,40.447003],[-79.976795,40.460579],[-79.962044,40.479526],[-79.937875,40.48998],[-79.926843,40.490149],[-79.906974,40.48522],[-79.884042,40.482457]],[[-80.051477,40.4835],[-80.040779,40.491422],[-80.027895,40.491084],[-80.017065,40.499804],[-80.00407,40.497782],[-80.001674,40.480087],[-79.988102,40.47682],[-79.983944,40.458276],[-79.998301,40.448341],[-80.014408,40.444677],[-80.033763,40.453333],[-80.035475,40.460584],[-80.051477,40.4835]]]}}}],"polygon-defaultLayerId",[],false,"#AAFFFFFF",{"stroke_colour":[false]},[[-80.0946973,40.361610400000007],[-79.8657728,40.4998036]],true,false,null,false,1,null]},{"functions":"add_scatterplot_geo_columnar","args":["mapdeck",{"fill_colour":[68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0],"stroke_colour":[68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0,68.0,1.0,84.0,255.0],"stroke_width":[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],"radius":[100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0],"lat":[40.441326,40.440877,40.43903,40.4372,40.435887,40.438882,40.440193,40.437643,40.440368,40.445844,40.444665,40.444777,40.445834,40.447166,40.450595,40.455091,40.449631,40.451742,40.47815,40.470212,40.465893,40.462769,40.459812,40.456505,40.458714,40.464443,40.461603,40.458972,40.455821,40.457415,40.45628,40.453382,40.45177,40.448419,40.446744,40.442398,40.441032,40.434338,40.437987,40.445128,40.442325,40.445236,40.45351,40.435986,40.4279,40.42802,40.428576,40.429338,40.428661,40.437766,40.45803,40.43866,40.44197,40.456328,40.458148,40.462026,40.464736,40.464605,40.460891,40.453046,40.438053,40.435319,40.43251,40.43269,40.431289,40.427088,40.429685,40.438749,40.441362,40.443244,40.44302,40.445649,40.444244,40.437753,40.437916,40.446739,40.451862,40.456238,40.456687,40.463617,40.467715,40.471223,40.461507,40.464907,40.47604,40.462184,40.460111,40.454001,40.447208,40.444751,40.441705,40.443534,40.441934,40.440015,40.437663,40.438296,40.453797,40.457773,40.447412,40.465299],"lon":[-80.004679,-80.00308,-80.00186,-80.000375,-79.997102,-79.997592,-79.995084,-79.986695,-79.988636,-79.99238,-79.995798,-80.000831,-80.008882,-80.003566,-80.013204,-80.006347,-79.985893,-79.983217,-79.9557,-79.960663,-79.954417,-79.950867,-79.945548,-79.939362,-79.933483,-79.933188,-79.925624,-79.922023,-79.915248,-79.92492,-79.930962,-79.92731,-79.932324,-79.947401,-79.950881,-79.951479,-79.948042,-79.951877,-79.95367,-79.957102,-79.957604,-79.976911,-79.94747,-79.956942,-79.966112,-79.969799,-79.974559,-79.980684,-79.986358,-79.990653,-79.9112,-79.9997,-79.9997,-79.980211,-79.973838,-79.968115,-79.942827,-79.93876,-79.915838,-79.898479,-79.922947,-79.922887,-79.92734,-80.003021,-79.995269,-79.962798,-79.95414,-79.957032,-79.955556,-79.959843,-79.953314,-79.953277,-79.948953,-79.933637,-79.927812,-79.94893,-79.951737,-79.905056,-79.898136,-79.917469,-79.92787,-79.925602,-79.935102,-79.960084,-79.957638,-79.96162,-79.97276,-79.981713,-79.989725,-79.993912,-79.995103,-79.998397,-80.002071,-80.00448,-79.996294,-79.981177,-79.99094,-80.009458,-80.012065,-79.965277],"geometry":[-80.004679,40.441326,-80.00308,40.440877,-80.00186,40.43903,-80.000375,40.4372,-79.997102,40.435887,-79.997592,40.438882,-79.995084,40.440193,-79.986695,40.437643,-79.988636,40.440368,-79.99238,40.445844,-79.995798,40.444665,-80.000831,40.444777,-80.008882,40.445834,-80.003566,40.447166,-80.013204,40.450595,-80.006347,40.455091,-79.985893,40.449631,-79.983217,40.451742,-79.9557,40.47815,-79.960663,40.470212,-79.954417,40.465893,-79.950867,40.462769,-79.945548,40.459812,-79.939362,40.456505,-79.933483,40.458714,-79.933188,40.464443,-79.925624,40.461603,-79.922023,40.458972,-79.915248,40.455821,-79.92492,40.457415,-79.930962,40.45628,-79.92731,40.453382,-79.932324,40.45177,-79.947401,40.448419,-79.950881,40.446744,-79.951479,40.442398,-79.948042,40.441032,-79.951877,40.434338,-79.95367,40.437987,-79.957102,40.445128,-79.957604,40.442325,-79.976911,40.445236,-79.94747,40.45351,-79.956942,40.435986,-79.966112,40.4279,-79.969799,40.42802,-79.974559,40.428576,-79.980684,40.429338,-79.986358,40.428661,-79.990653,40.437766,-79.9112,40.45803,-79.9997,40.43866,-79.9997,40.44197,-79.980211,40.456328,-79.973838,40.458148,-79.968115,40.462026,-79.942827,40.464736,-79.93876,40.464605,-79.915838,40.460891,-79.898479,40.453046,-79.922947,40.438053,-79.922887,40.435319,-79.92734,40.43251,-80.003021,40.43269,-79.995269,40.431289,-79.962798,40.427088,-79.95414,40.429685,-79.957032,40.438749,-79.955556,40.441362,-79.959843,40.443244,-79.953314,40.44302,-79.953277,40.445649,-79.948953,40.444244,-79.933637,40.437753,-79.927812,40.437916,-79.94893,40.446739,-79.951737,40.451862,-79.905056,40.456238,-79.898136,40.456687,-79.917469,40.463617,-79.92787,40.467715,-79.925602,40.471223,-79.935102,40.461507,-79.960084,40.464907,-79.957638,40.47604,-79.96162,40.462184,-79.97276,40.460111,-79.981713,40.454001,-79.989725,40.447208,-79.993912,40.444751,-79.995103,40.441705,-79.998397,40.443534,-80.002071,40.441934,-80.00448,40.440015,-79.996294,40.437663,-79.981177,40.438296,-79.99094,40.453797,-80.009458,40.457773,-80.012065,40.447412,-79.965277,40.465299]},100,"scatterplot-defaultLayerId",false,"#AAFFFFFF",[],"rgb",[[-80.013204,40.42708753],[-79.89813566,40.47815]],true,false,null,1,null,null]},{"functions":"md_change_location","args":["mapdeck",[-79.96,40.45],11,null,null,null,"linear"]}]},"evals":[],"jsHooks":[]}</script>
<div id="build-one-isochone" class="section level2">
<h2>Build one isochone</h2>
<p>This takes the first station in the dataframe and uses the Mapbox API to make a test <a href="https://en.wikipedia.org/wiki/Isochrone_map">isochrone</a> that shows how far a bicyclist can go in a given period of time (5, 10, 15 minutes).</p>
<pre class="r"><code>test_isochrone_data &lt;- stations %&gt;% 
  slice(1) %&gt;% 
  st_as_sf(coords = c(&quot;longitude&quot;, &quot;latitude&quot;), crs = 4326) %&gt;% 
  mb_isochrone(profile = &quot;cycling&quot;, time = c(5, 10, 15))

test_isochrone_map &lt;- mapbox_map %&gt;% 
  mapdeck() %&gt;% 
  add_polygon(data = test_isochrone_data,
              fill_colour = &quot;time&quot;,
              fill_opacity = 0.5,
              legend = TRUE) %&gt;% 
  add_scatterplot(data = stations %&gt;% 
                          slice(1) %&gt;% 
                          st_as_sf(coords = c(&quot;longitude&quot;, &quot;latitude&quot;), crs = 4326),
                  radius = 100,
                  fill_colour = &quot;#ffffff&quot;) %&gt;% 
  mapdeck_view(location = c(pgh_coords[1], pgh_coords[2]), zoom = 11)

test_isochrone_map</code></pre>
<div id="htmlwidget-3" style="width:672px;height:480px;" class="mapdeck html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"access_token":"pk.eyJ1IjoiY29ub3JvdG9tcGtpbnMiLCJhIjoiY2p2b2MxeTNqMTg3ZjRhbnQwMTk0ZGt0ZyJ9.tfEDs2o7n8kKtHvcTneG_g","style":"mapbox://styles/mapbox/streets-v9","pitch":0,"zoom":0,"location":[0,0],"bearing":0,"max_zoom":20,"min_zoom":0,"max_pitch":60,"min_pitch":0,"show_view_state":false,"repeat_view":false,"calls":[{"functions":"add_polygon_geo","args":["mapdeck",[{"type":"Feature","properties":{"elevation":0,"fill_colour":"#FDE7257F","stroke_colour":"#440154FF"},"geometry":{"geometry":{"type":"Polygon","coordinates":[[[-79.975679,40.469445],[-79.979076,40.466723],[-79.980606,40.464253],[-79.98174,40.463326],[-79.983558,40.462205],[-79.985317,40.461964],[-79.986231,40.460878],[-79.986679,40.460688],[-79.987075,40.461326],[-79.985348,40.462995],[-79.985679,40.464702],[-79.98787,40.463517],[-79.989679,40.461817],[-79.994081,40.461728],[-79.996679,40.459126],[-79.997679,40.459153],[-79.997921,40.459568],[-79.99799,40.461326],[-79.997077,40.462326],[-79.997889,40.463116],[-79.998544,40.465326],[-79.998324,40.467326],[-80.000073,40.467932],[-80.000679,40.46864],[-80.001376,40.468629],[-80.001679,40.469218],[-80.001863,40.468326],[-80.000239,40.466326],[-80.002201,40.464326],[-80.001119,40.462326],[-80.001308,40.460326],[-80.002679,40.459139],[-80.003803,40.459202],[-80.004679,40.460105],[-80.007801,40.460204],[-80.007022,40.461669],[-80.007679,40.462998],[-80.009162,40.462809],[-80.010679,40.46103],[-80.012679,40.46095],[-80.013221,40.461326],[-80.013679,40.463053],[-80.014679,40.460865],[-80.016894,40.461111],[-80.01733,40.462675],[-80.01851,40.463495],[-80.020071,40.463718],[-80.02041,40.463326],[-80.019274,40.461731],[-80.019344,40.460991],[-80.022426,40.460073],[-80.022838,40.459485],[-80.0242,40.459326],[-80.025679,40.455752],[-80.026679,40.455618],[-80.028501,40.454326],[-80.029584,40.454231],[-80.029516,40.453326],[-80.028511,40.452494],[-80.028442,40.451326],[-80.027387,40.450034],[-80.028863,40.450142],[-80.02912,40.450885],[-80.030774,40.452326],[-80.029279,40.454926],[-80.029679,40.456195],[-80.030721,40.456284],[-80.031679,40.45701],[-80.033401,40.455048],[-80.033934,40.455071],[-80.034279,40.457326],[-80.033578,40.458427],[-80.034679,40.459288],[-80.035091,40.453914],[-80.030539,40.449466],[-80.030274,40.448731],[-80.028679,40.448518],[-80.028327,40.447678],[-80.027513,40.447326],[-80.028679,40.445886],[-80.030027,40.445978],[-80.030399,40.446606],[-80.030959,40.446606],[-80.031135,40.445326],[-80.030196,40.444326],[-80.03183,40.443175],[-80.030679,40.442926],[-80.029679,40.441831],[-80.028679,40.442759],[-80.025679,40.442693],[-80.025124,40.441881],[-80.023679,40.441624],[-80.022679,40.440605],[-80.019679,40.440549],[-80.019263,40.439742],[-80.017574,40.439431],[-80.017374,40.438631],[-80.015612,40.438393],[-80.015482,40.437523],[-80.014608,40.437397],[-80.014417,40.436588],[-80.012598,40.436407],[-80.012442,40.435563],[-80.011602,40.435403],[-80.011453,40.434552],[-80.010562,40.434326],[-80.011431,40.434078],[-80.011593,40.43324],[-80.012416,40.433063],[-80.012588,40.432235],[-80.013399,40.432046],[-80.013582,40.431229],[-80.014379,40.431026],[-80.014575,40.430222],[-80.015357,40.430004],[-80.015567,40.429214],[-80.016331,40.428978],[-80.017679,40.427118],[-80.020679,40.427077],[-80.021679,40.428044],[-80.022884,40.428121],[-80.023325,40.43068],[-80.025061,40.430708],[-80.025122,40.426883],[-80.022679,40.426614],[-80.02217,40.425835],[-80.019509,40.424496],[-80.018679,40.423611],[-80.017964,40.424326],[-80.017827,40.425474],[-80.016087,40.425734],[-80.014797,40.427444],[-80.014022,40.427669],[-80.013788,40.428435],[-80.012996,40.428643],[-80.01278,40.429427],[-80.011975,40.429622],[-80.011774,40.430421],[-80.010955,40.430602],[-80.010768,40.431415],[-80.009939,40.431586],[-80.009763,40.43241],[-80.008924,40.432571],[-80.008679,40.433431],[-80.008461,40.432544],[-80.006614,40.432391],[-80.006259,40.430746],[-80.004593,40.430412],[-80.004405,40.4296],[-80.001679,40.429428],[-80.001397,40.428608],[-79.998679,40.428445],[-79.998412,40.427593],[-79.996581,40.427424],[-79.996363,40.426642],[-79.994563,40.426442],[-79.994314,40.425691],[-79.987679,40.42549],[-79.987244,40.424761],[-79.986469,40.424536],[-79.985083,40.42473],[-79.984679,40.425516],[-79.983679,40.424601],[-79.980679,40.424455],[-79.979679,40.423722],[-79.978315,40.42369],[-79.977679,40.422723],[-79.975879,40.423326],[-79.976225,40.424326],[-79.975679,40.424755],[-79.974679,40.423814],[-79.972612,40.424326],[-79.973243,40.425326],[-79.972679,40.425861],[-79.971679,40.42501],[-79.966679,40.426934],[-79.96717,40.428326],[-79.968781,40.429326],[-79.968634,40.431371],[-79.972679,40.431931],[-79.972682,40.434326],[-79.971679,40.434503],[-79.970679,40.433531],[-79.968679,40.433545],[-79.967679,40.434752],[-79.965679,40.432615],[-79.964679,40.433935],[-79.963679,40.433143],[-79.962751,40.433326],[-79.96332,40.433685],[-79.963109,40.434755],[-79.960688,40.435326],[-79.962053,40.436952],[-79.96209,40.437737],[-79.960595,40.438326],[-79.962679,40.438595],[-79.964679,40.437001],[-79.970679,40.437136],[-79.971029,40.437976],[-79.972068,40.438326],[-79.972249,40.440756],[-79.973971,40.442326],[-79.97186,40.444507],[-79.969679,40.444669],[-79.968679,40.44573],[-79.967323,40.44597],[-79.966422,40.447583],[-79.967679,40.447821],[-79.968376,40.447023],[-79.969679,40.446959],[-79.970679,40.446021],[-79.971679,40.446048],[-79.971998,40.446326],[-79.971203,40.447326],[-79.97132,40.448685],[-79.972679,40.448886],[-79.973419,40.448066],[-79.974679,40.447981],[-79.975679,40.447068],[-79.978679,40.449924],[-79.980054,40.449701],[-79.980419,40.448066],[-79.984817,40.448188],[-79.982956,40.448603],[-79.982679,40.449466],[-79.980985,40.449632],[-79.980679,40.450488],[-79.979023,40.45067],[-79.977679,40.452524],[-79.976074,40.452721],[-79.975679,40.453497],[-79.974044,40.453691],[-79.971679,40.455963],[-79.970408,40.456326],[-79.970877,40.457524],[-79.969516,40.458163],[-79.969281,40.458928],[-79.967917,40.459326],[-79.969965,40.46104],[-79.969982,40.461629],[-79.969122,40.462326],[-79.969371,40.462634],[-79.971679,40.463144],[-79.972373,40.46302],[-79.972673,40.46232],[-79.97325,40.462755],[-79.974884,40.462531],[-79.977458,40.460105],[-79.97897,40.460035],[-79.975266,40.464326],[-79.975251,40.465898],[-79.974619,40.466386],[-79.975731,40.467274],[-79.975186,40.469326],[-79.975679,40.469445]]]}}},{"type":"Feature","properties":{"elevation":0,"fill_colour":"#21908C7F","stroke_colour":"#440154FF"},"geometry":{"geometry":{"type":"Polygon","coordinates":[[[-80.005614,40.458391],[-80.003679,40.457134],[-80.001679,40.458219],[-80.001445,40.45756],[-80.000531,40.457178],[-79.999854,40.457501],[-79.999679,40.458144],[-79.997679,40.457765],[-79.995284,40.456326],[-79.993679,40.456166],[-79.991679,40.456271],[-79.990679,40.45678],[-79.988877,40.456524],[-79.988679,40.457339],[-79.987558,40.457205],[-79.985679,40.4582],[-79.98537,40.457326],[-79.987303,40.45495],[-79.988922,40.454569],[-79.989885,40.453532],[-79.989888,40.452117],[-79.988679,40.452],[-79.987679,40.452681],[-79.986106,40.452753],[-79.985817,40.454464],[-79.983844,40.454491],[-79.983679,40.454963],[-79.981372,40.454633],[-79.980702,40.453303],[-79.979812,40.453193],[-79.980202,40.451326],[-79.981445,40.450092],[-79.982679,40.449787],[-79.983313,40.44896],[-79.986679,40.447575],[-79.987679,40.44656],[-79.988679,40.446537],[-79.98879,40.445437],[-79.98939,40.445615],[-79.989858,40.445147],[-79.987679,40.444947],[-79.986679,40.444174],[-79.985679,40.444589],[-79.983283,40.443722],[-79.980679,40.444019],[-79.98002,40.443326],[-79.980606,40.441326],[-79.980179,40.439826],[-79.976679,40.438055],[-79.975679,40.438163],[-79.974495,40.43751],[-79.972428,40.437326],[-79.972587,40.436234],[-79.973679,40.435847],[-79.974679,40.436819],[-79.978679,40.436758],[-79.979336,40.436326],[-79.97914,40.435865],[-79.977802,40.435326],[-79.982679,40.434722],[-79.983679,40.433753],[-79.987848,40.433495],[-79.987679,40.431873],[-79.985679,40.431627],[-79.984679,40.430741],[-79.982476,40.430326],[-79.983729,40.428326],[-79.98731,40.426326],[-79.988679,40.426179],[-79.98906,40.426945],[-79.992367,40.427638],[-79.995679,40.427082],[-79.996316,40.427689],[-79.997679,40.427727],[-79.998679,40.428619],[-80.000339,40.428666],[-80.001508,40.429497],[-80.004054,40.429951],[-80.005283,40.431326],[-80.006285,40.43172],[-80.006554,40.432451],[-80.008201,40.432804],[-80.008679,40.433548],[-80.012389,40.430036],[-80.014679,40.428771],[-80.014851,40.429326],[-80.013948,40.430595],[-80.010399,40.434326],[-80.012474,40.436531],[-80.013679,40.436704],[-80.01529,40.437715],[-80.015543,40.438462],[-80.016918,40.439087],[-80.017831,40.440326],[-80.016679,40.440541],[-80.013996,40.440009],[-80.013346,40.439326],[-80.012567,40.439214],[-80.012591,40.440414],[-80.014384,40.440621],[-80.01438,40.443027],[-80.010679,40.443187],[-80.010571,40.444434],[-80.012679,40.444511],[-80.013679,40.443528],[-80.015679,40.443549],[-80.016679,40.444566],[-80.019679,40.444635],[-80.020679,40.445675],[-80.023679,40.445829],[-80.024679,40.446928],[-80.026712,40.447326],[-80.023826,40.447473],[-80.023679,40.448868],[-80.020459,40.451106],[-80.019679,40.452405],[-80.018116,40.452326],[-80.017278,40.451326],[-80.015679,40.45107],[-80.014991,40.450326],[-80.01541,40.449326],[-80.011679,40.44912],[-80.010332,40.450326],[-80.010815,40.451326],[-80.010166,40.452326],[-80.01026,40.453326],[-80.013933,40.454326],[-80.0107,40.457326],[-80.007679,40.459131],[-80.005614,40.458391]]]}}},{"type":"Feature","properties":{"elevation":0,"fill_colour":"#4401547F","stroke_colour":"#440154FF"},"geometry":{"geometry":{"type":"Polygon","coordinates":[[[-80.002522,40.450483],[-80.001679,40.449815],[-80.000679,40.449781],[-80.000569,40.449436],[-79.998679,40.44891],[-79.997652,40.449326],[-79.997569,40.448216],[-79.999053,40.4477],[-79.999305,40.446952],[-79.99933,40.446326],[-79.998679,40.44577],[-79.997679,40.446944],[-79.996359,40.447006],[-79.995679,40.447791],[-79.992679,40.446794],[-79.990679,40.446805],[-79.989566,40.446326],[-79.990375,40.445326],[-79.992018,40.444665],[-79.992171,40.442834],[-79.991411,40.442326],[-79.991338,40.440985],[-79.9916,40.440247],[-79.993451,40.439326],[-79.992679,40.43873],[-79.991485,40.43852],[-79.991471,40.438118],[-79.992679,40.43802],[-79.99421,40.436857],[-79.994302,40.435326],[-79.996173,40.434326],[-79.99675,40.434255],[-79.997613,40.435392],[-80.000916,40.435563],[-80.001425,40.434072],[-80.003583,40.43223],[-80.004164,40.432326],[-80.004223,40.433326],[-80.003185,40.433832],[-80.002427,40.435578],[-80.003469,40.436536],[-80.004679,40.436654],[-80.005679,40.437537],[-80.007365,40.43764],[-80.008481,40.438524],[-80.011372,40.439019],[-80.011679,40.438515],[-80.012421,40.440584],[-80.013973,40.441032],[-80.014088,40.442326],[-80.013679,40.442735],[-80.010363,40.44301],[-80.009896,40.444326],[-80.010475,40.445326],[-80.007977,40.446326],[-80.008724,40.447326],[-80.007337,40.449326],[-80.005908,40.449555],[-80.005679,40.450485],[-80.00501,40.450657],[-80.002522,40.450483]]]}}}],"polygon-defaultLayerId",[],false,"#AAFFFFFF",{"fill_colour":{"colour":["#440154FF","#21908CFF","#FDE725FF"],"variable":["5.00","10.00","15.00"],"colourType":["fill_colour"],"type":["gradient"],"title":["time"],"css":[""]}},[[-80.035091,40.422723],[-79.960595,40.469445]],true,false,null,false,1,null]},{"functions":"add_scatterplot_geo_columnar","args":["mapdeck",{"fill_colour":[255.0,255.0,255.0,255.0],"stroke_colour":[68.0,1.0,84.0,255.0],"stroke_width":[0.0],"radius":[100.0],"lat":[40.441326],"lon":[-80.004679],"geometry":[-80.004679,40.441326]},1,"scatterplot-defaultLayerId",false,"#AAFFFFFF",{"fill_colour":[false]},"rgb",[[-80.004679,40.441326],[-80.004679,40.441326]],true,false,null,1,null,null]},{"functions":"md_change_location","args":["mapdeck",[-79.96,40.45],11,null,null,null,"linear"]}]},"evals":[],"jsHooks":[]}</script>
<p>The same graph can be made in <code>ggplot2</code>:</p>
<pre class="r"><code>test_isochrone_data %&gt;% 
  ggplot() +
  geom_sf(aes(fill = time)) +
  scale_fill_viridis_c() +
  theme_void()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>This calculates the isochrones for all the stations and transforms them into a projected coordinate system:</p>
<pre class="r"><code>station_isochrone &lt;- stations %&gt;%
  st_as_sf(coords = c(&quot;longitude&quot;, &quot;latitude&quot;), crs = 4326) %&gt;%
  mb_isochrone(profile = &quot;cycling&quot;, time = c(10)) %&gt;%
  st_transform(3857)</code></pre>
<p>This shows the overlap between all the isochrones. Interesting to look at, but not very informative.</p>
<pre class="r"><code>station_isochrone %&gt;% 
  ggplot() +
  geom_sf(fill = &quot;black&quot;, size = NA, alpha = .05) +
  theme_void()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="build-raster" class="section level2">
<h2>Build Raster</h2>
<p>This builds a raster object that calculates how many isochrones overlap on a given area:</p>
<pre class="r"><code>#raster
polygons_proj &lt;- station_isochrone %&gt;%
  mutate(test_id = 1) %&gt;% 
  filter(time == 10) %&gt;% 
  st_transform(3857)

template &lt;- raster(polygons_proj, resolution = 25)

raster_surface &lt;- fasterize(polygons_proj, template, field = &quot;test_id&quot;, fun = &quot;sum&quot;)

raster_values &lt;- tibble(values = values(raster_surface)) %&gt;% 
  filter(!is.na(values)) %&gt;% 
  distinct(values) %&gt;% 
  pull(values)

plot(raster_surface)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="build-interactive-map" class="section level2">
<h2>Build interactive Map</h2>
<p>This builds out the interactive map using <code>leaflet</code> and Mapbox libraries:</p>
<pre class="r"><code>custom_pal &lt;- colorNumeric(&quot;viridis&quot;, 
                           #0:max_bike_stations, 
                           raster_values,
                           na.color = &quot;transparent&quot;)

popup_labels &lt;- sprintf(&quot;%s 
                        &lt;br&gt;Number of bike racks: %s&quot;,
                        stations$station_name, stations$number_of_racks) %&gt;% 
  map(htmltools::HTML)

health_ride_icon &lt;- makeIcon(
  iconUrl = &quot;https://healthyridepgh.com/wp-content/uploads/sites/3/2019/05/NEXTBIKE-LOGO-01.png&quot;,
  #iconUrl = &quot;https://healthyridepgh.com/wp-content/uploads/sites/3/2016/09/Healthy-Ride-Logo.Stacked-01.png&quot;,
  iconWidth = 50, iconHeight = 50,
  iconAnchorX = 0, iconAnchorY = 0
)

station_heatmap &lt;- mapbox_map %&gt;%
  addPolygons(data = city_boundary,
              opacity = 1,
              color = &quot;black&quot;,
              fillColor = &quot;#ffffff&quot;,
              group = &quot;City boundary&quot;) %&gt;% 
  addRasterImage(raster_surface, colors = custom_pal, opacity = .75,
                 group = &quot;Raster&quot;) %&gt;% 
  addLegend(pal = custom_pal, 
            values = raster_values,
            title = &quot;Number of stations&lt;br&gt;within 10-minute bike ride&quot;) %&gt;% 
  addMarkers(data = stations, lng = ~longitude, lat = ~latitude,
             popup = popup_labels,
             icon = health_ride_icon,
             clusterOptions = markerClusterOptions(),
             group = &quot;Stations&quot;) %&gt;% 
  addLayersControl(overlayGroups = c(&quot;City boundary&quot;, &quot;Raster&quot;, &quot;Stations&quot;),
                   options = layersControlOptions(collapsed = FALSE)) %&gt;% 
  addFullscreenControl() %&gt;% 
  setView(lng = pgh_coords[1], lat = pgh_coords[2], zoom = 12)

frameWidget(station_heatmap, options=frameOptions(allowfullscreen = TRUE))</code></pre>
</div>
</div>
