---
# Documentation: https://sourcethemes.com/academic/docs/managing-content/

title: "Cumulative eBird Sightings in Allegheny County"
subtitle: ""
summary: ""
authors: [Conor Tompkins]
tags: [R, eBird, Allegheny County]
categories: [R, eBird, Allegheny County]
date: 2020-04-29
lastmod: 2020-08-07T16:53:58-04:00
featured: false
draft: false

# Featured image
# To use, add an image named `featured.jpg/png` to your page's folder.
# Focal points: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight.
image:
  caption: ""
  focal_point: ""
  preview_only: false

# Projects (optional).
#   Associate this post with one or more of your projects.
#   Simply enter your project's folder or file name without extension.
#   E.g. `projects = ["internal-project"]` references `content/project/deep-learning/index.md`.
#   Otherwise, set `projects = []`.
projects: []
---



<p>This will be a quick post on cumulative bird observations in Allegheny County. Cumulative graphs show overall trends, seasonality, and quirks in how the data was recorded. They are also fun to turn into animated gifs with <code>gganimate</code>.</p>
<p>Load the relevant libraries:</p>
<pre class="r"><code>library(tidyverse)
library(lubridate)
library(tidyquant)
library(janitor)
library(hrbrthemes)
library(vroom)
library(ggrepel)
library(gganimate)

set.seed(1234)

theme_set(theme_bw(base_size = 16))</code></pre>
<p>This reads in data from the <a href="https://ebird.org/data/download">eBird data portal</a>:</p>
<pre class="r"><code>df &lt;- vroom(&quot;data/ebd_US-PA-003_201001_202003_relFeb-2020.zip&quot;, delim = &quot;\t&quot;) %&gt;% 
  clean_names() %&gt;% 
  mutate_at(vars(observer_id, locality, observation_date, time_observations_started, protocol_type), str_replace_na, &quot;NA&quot;) %&gt;% 
  mutate(observation_count = as.numeric(str_replace(observation_count, &quot;X&quot;, as.character(NA))),
         observation_event_id = str_c(observer_id, locality, observation_date, time_observations_started, sep = &quot;-&quot;),
         observation_date = ymd(observation_date)) %&gt;%
  filter(all_species_reported == 1)

glimpse(df)</code></pre>
<pre><code>## Rows: 528,787
## Columns: 48
## $ global_unique_identifier     &lt;chr&gt; &quot;URN:CornellLabOfOrnithology:EBIRD:OBS81…
## $ last_edited_date             &lt;dttm&gt; 2018-08-03 11:44:16, 2018-08-03 11:44:3…
## $ taxonomic_order              &lt;dbl&gt; 493, 20638, 20638, 20638, 20638, 20638, …
## $ category                     &lt;chr&gt; &quot;species&quot;, &quot;species&quot;, &quot;species&quot;, &quot;specie…
## $ common_name                  &lt;chr&gt; &quot;American Black Duck&quot;, &quot;American Crow&quot;, …
## $ scientific_name              &lt;chr&gt; &quot;Anas rubripes&quot;, &quot;Corvus brachyrhynchos&quot;…
## $ subspecies_common_name       &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ subspecies_scientific_name   &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ observation_count            &lt;dbl&gt; 1, 7, 3, 2, 4, 3, NA, 3, NA, NA, 6, NA, …
## $ breeding_bird_atlas_code     &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ breeding_bird_atlas_category &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ age_sex                      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, &quot;Unknown Sex…
## $ country                      &lt;chr&gt; &quot;United States&quot;, &quot;United States&quot;, &quot;Unite…
## $ country_code                 &lt;chr&gt; &quot;US&quot;, &quot;US&quot;, &quot;US&quot;, &quot;US&quot;, &quot;US&quot;, &quot;US&quot;, &quot;US&quot;…
## $ state                        &lt;chr&gt; &quot;Pennsylvania&quot;, &quot;Pennsylvania&quot;, &quot;Pennsyl…
## $ state_code                   &lt;chr&gt; &quot;US-PA&quot;, &quot;US-PA&quot;, &quot;US-PA&quot;, &quot;US-PA&quot;, &quot;US-…
## $ county                       &lt;chr&gt; &quot;Allegheny&quot;, &quot;Allegheny&quot;, &quot;Allegheny&quot;, &quot;…
## $ county_code                  &lt;chr&gt; &quot;US-PA-003&quot;, &quot;US-PA-003&quot;, &quot;US-PA-003&quot;, &quot;…
## $ iba_code                     &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ bcr_code                     &lt;dbl&gt; 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, …
## $ usfws_code                   &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ atlas_block                  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ locality                     &lt;chr&gt; &quot;Rachel Carson Riverfront Park&quot;, &quot;Souths…
## $ locality_id                  &lt;chr&gt; &quot;L2640334&quot;, &quot;L841018&quot;, &quot;L329082&quot;, &quot;L6920…
## $ locality_type                &lt;chr&gt; &quot;H&quot;, &quot;H&quot;, &quot;H&quot;, &quot;P&quot;, &quot;P&quot;, &quot;H&quot;, &quot;H&quot;, &quot;P&quot;, …
## $ latitude                     &lt;dbl&gt; 40.53731, 40.43124, 40.54348, 40.65688, …
## $ longitude                    &lt;dbl&gt; -79.79531, -79.97032, -79.90623, -80.113…
## $ observation_date             &lt;date&gt; 2010-01-14, 2010-01-31, 2010-01-23, 201…
## $ time_observations_started    &lt;chr&gt; &quot;11:05:00&quot;, &quot;16:45:00&quot;, &quot;13:15:00&quot;, &quot;14:…
## $ observer_id                  &lt;chr&gt; &quot;obsr39944&quot;, &quot;obsr197993&quot;, &quot;obsr197993&quot;,…
## $ sampling_event_identifier    &lt;chr&gt; &quot;S5760087&quot;, &quot;S5839167&quot;, &quot;S5798726&quot;, &quot;S58…
## $ protocol_type                &lt;chr&gt; &quot;Traveling&quot;, &quot;Traveling&quot;, &quot;Area&quot;, &quot;Trave…
## $ protocol_code                &lt;chr&gt; &quot;P22&quot;, &quot;P22&quot;, &quot;P23&quot;, &quot;P22&quot;, &quot;P21&quot;, &quot;P23&quot;…
## $ project_code                 &lt;chr&gt; &quot;EBIRD&quot;, &quot;EBIRD&quot;, &quot;EBIRD&quot;, &quot;EBIRD&quot;, &quot;EBI…
## $ duration_minutes             &lt;dbl&gt; 25, 30, 90, 90, 120, 30, 35, 60, 120, NA…
## $ effort_distance_km           &lt;dbl&gt; 0.483, 0.483, NA, 8.047, NA, NA, NA, NA,…
## $ effort_area_ha               &lt;dbl&gt; NA, NA, 24.2811, NA, NA, 4.0469, 4.0469,…
## $ number_observers             &lt;dbl&gt; 1, 2, 2, 1, NA, 2, 2, 1, 1, 1, 1, NA, 1,…
## $ all_species_reported         &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ group_identifier             &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ has_media                    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ approved                     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ reviewed                     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ reason                       &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ trip_comments                &lt;chr&gt; NA, NA, NA, NA, NA, &quot;Temperature 8F Wind…
## $ species_comments             &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ x47                          &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ observation_event_id         &lt;chr&gt; &quot;obsr39944-Rachel Carson Riverfront Park…</code></pre>
<p>I focus on the two main ways people use the eBird app: traveling and stationary. I also filter to only observations from 2016 onwards, since that is when eBird usage became stable in the county.</p>
<pre class="r"><code>df_top_protocols &lt;- df %&gt;% 
  count(protocol_type, sort = TRUE) %&gt;% 
  slice(1:2)

df &lt;- df %&gt;% 
  semi_join(df_top_protocols) %&gt;% 
  filter(year(observation_date) &gt;= 2016)</code></pre>
<p>This identifies the top 10 birds in terms of total observations:</p>
<pre class="r"><code>df_species_count &lt;- df %&gt;% 
  group_by(common_name) %&gt;% 
  summarize(observation_count = sum(observation_count, na.rm = TRUE)) %&gt;% 
  arrange(desc(observation_count)) %&gt;% 
  slice(1:10)</code></pre>
<p>This code filters on the top 10 birds and caculates the cumulative number of sightings and the rolling 21 day average of sightings.</p>
<pre class="r"><code>df_cumulative &lt;- df %&gt;% 
  semi_join(df_species_count, by = c(&quot;common_name&quot;)) %&gt;% 
  group_by(common_name, observation_date) %&gt;% 
  summarize(observation_count = sum(observation_count, na.rm = TRUE)) %&gt;% 
  ungroup() %&gt;% 
  arrange(common_name, observation_date) %&gt;% 
  group_by(common_name) %&gt;% 
  mutate(observation_count_cumulative = cumsum(observation_count)) %&gt;% 
  tq_mutate(
    # tq_mutate args
    select     = observation_count,
    mutate_fun = rollapply, 
    # rollapply args
    width      = 21,
    align      = &quot;right&quot;,
    FUN        = mean,
    # mean args
    na.rm      = TRUE,
    # tq_mutate args
    col_rename = &quot;mean_21&quot;
  )</code></pre>
<p>This plots the cumulative observations by bird and creates an animation with <code>gganimate</code>:</p>
<pre class="r"><code>plot &lt;- df_cumulative %&gt;% 
  ggplot(aes(observation_date, observation_count_cumulative, group = common_name)) +
  geom_line(alpha = .5) +
  geom_segment(aes(xend = last(df_cumulative$observation_date) + 240, yend = observation_count_cumulative), linetype = 2, colour = &#39;grey&#39;) +
  geom_point(aes(size = mean_21)) +
  geom_label(aes(x = last(df_cumulative$observation_date) + 210, label = common_name), size = 6) +
  scale_y_comma() +
  scale_size_continuous(&quot;21 day rolling average of observation count&quot;, range = c(2, 10), labels = scales::comma) +
  scale_x_date(limits = c(first(df_cumulative$observation_date), last(df_cumulative$observation_date) + 250)) +
  labs(x = NULL,
       y = &quot;Cumulative observations&quot;,
       title = &quot;eBird observations in Allegheny County&quot;,
       subtitle = &quot;Top 10 birds 2016 through January 2020&quot;,
       caption = &quot;@conor_tompkins&quot;) +
  coord_cartesian(clip = &#39;off&#39;) +
  transition_reveal(observation_date)

plot</code></pre>
<p><img src="cumulative_observations.gif" /></p>
